name: Performance tests
on:
  # Note: schedule only triggers on `main` branch
  schedule:
    # 6 is Saturday (currently day of the general meeting)
    - cron: 30 12 * * 6
  workflow_dispatch:

concurrency:
  # ref will be always the same (`main`) for schedule, and can be set manually for workflow-dispatch
  group: ${{ github.workflow }}-${{ github.ref }}
  # Cancel in-progress runs when a new workflow with the same group name is triggered
  cancel-in-progress: true

jobs:
  turn-test-server-on:
    runs-on: ubuntu-latest
    steps:
      - name: Turn test server on
        run: |
          curl -X POST \
          -H "Authorization: Bearer ${{ secrets.REGRU_API_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{"type": "start"}' \
          'https://api.cloudvps.reg.ru/v1/reglets/${{ vars.REGRU_SERVER_ID }}/actions'
      - name: Wait for the server to start
        run: sleep 30
      - name: Check that server is running
        run: |
          STATUS=$(curl -X GET -H "Authorization: Bearer ${{ secrets.REGRU_API_KEY }}" \
           -H "Content-Type: application/json" \
           'https://api.cloudvps.reg.ru/v1/reglets/${{ vars.REGRU_SERVER_ID }}' -s | \
           awk '/"status":/ {match($2, /[a-z]+/); print substr($2, RSTART, RLENGTH)}')

          if [[ "$STATUS" != "active" ]]; then
            echo "::error title=Start failed::Server is not running. Status is $STATUS."
            exit 1
          fi

  performance-tests:
    runs-on: self-hosted
    needs: turn-test-server-on
    env:
      LogDirName: /home/github-user/performance-tests
      OldFilename: # set dynamically
      NewFilename: # set dynamically
    steps:
      # GitHub creates new clear VM on its runner here
      # Without this step checkout is unable to clear repository, because `lib` somehow
      # contains files, owned by `root`
      - name: Clear working directory
        run: sudo rm -rf ${{ github.workspace }}/*
      - uses: actions/checkout@v4
      - name: Install dependencies
        uses: ./.github/composite-actions/install-dependencies
        with:
          os: ubuntu-latest
          toolset: gcc
      - name: Download datasets
        uses: ./.github/composite-actions/download-datasets
      - name: Build
        run: |
          export CXX=g++-10
          ./build.sh --perf-tests --no-tests
      - name: Select latest log
        run: |
          echo "OldFilename=$(ls ${{ env.LogDirName }} | grep -o "results-[0-9|:|-]*\.json" | \
          tail -n 1)" >> $GITHUB_ENV
      - name: Copy latest log
        run: |
          if [[ -z "${{ env.OldFilename }}" ]]; then
            echo "No file selected. Using empty JSON"
            # There are 2 possible problems:
            #   1. No such directory
            #   2. Directory is empty or doesn't contain any file that match regexp
            mkdir -p ${{ env.LogDirName }}
            echo "{}" > ${{ github.workspace }}/prev-results.json
          else
            cp ${{ env.LogDirName }}/${{ env.OldFilename }} \
              ${{ github.workspace }}/prev-results.json
          fi
      - name: Read downloaded file
        run: cat ${{ github.workspace }}/prev-results.json
      - name: Test
        working-directory: ${{github.workspace}}/build/target
        run: |
          ./Desbordante_perf_test ${{ github.workspace }}/prev-results.json \
           ${{ github.workspace }}/curr-results.json
      - name: Read current results
        run: cat ${{ github.workspace }}/curr-results.json
      - name: Select filename
        shell: bash
        run: echo "NewFilename=results-$(date +%F-%H:%M:%S).json" >> $GITHUB_ENV
      - name: Save current results
        run: |
          cp ${{ github.workspace }}/curr-results.json ${{ env.LogDirName }}/${{ env.NewFilename }}

  # If there's more than N files saved, purge the oldest ones
  purge-old-results:
    needs: performance-tests
    runs-on: self-hosted
    env:
      # Name of folder with test results
      LogDirName: /home/github-user/performance-tests
      # Number of files to keep
      N: 50
    steps:
      - name: Purge old files
        shell: bash
        run: |
          function get_num() {
            echo $(ls ${{ env.LogDirName }} | wc -l)
          }
          function get_first() {
            echo $(ls ${{ env.LogDirName }} | grep -o "results-[0-9|:|-]*\.json" | head -n1)
          }

          while [ $(get_num) -gt ${{ env.N }} ]; do
            rm ${{ env.LogDirName }}/$(get_first)
          done

  build-plot:
    runs-on: self-hosted
    needs: performance-tests
    env:
      # File to store test results
      Filename: # no value
      # Name of folder with test results
      LogDirName: /home/github-user/performance-tests
    steps:
      - name: Install matplotlib
        run: sudo apt install -y python3-matplotlib
      - name: Build plots
        working-directory: ${{ github.workspace }}
        run: |
          python3 src/tests/performance_tests/display_performance_tests.py \
           ${{ env.LogDirName }} plots.pdf
      - uses: actions/upload-artifact@v4
        with:
          name: plots.pdf
          path: ${{ github.workspace }}/plots.pdf
          if-no-files-found: error

  turn-test-server-off:
    runs-on: ubuntu-latest
    needs: [build-plot, purge-old-results]
    # Even if previous jobs failed, but not if cancelled
    # NB: Server *must* be disabled manually if job was cancelled
    if: ${{ !cancelled() }}
    steps:
      - name: Wait a little
        run: sleep 5
      - name: Turn test server off
        run: |
          ANSW=$(curl -X POST \
          -H "Authorization: Bearer ${{ secrets.REGRU_API_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{"type": "stop"}' \
          'https://api.cloudvps.reg.ru/v1/reglets/${{ vars.REGRU_SERVER_ID }}/actions')
      - name: Wait a little more
        run: sleep 60
      - name: Check that server is not running
        run: |
          STATUS=$(curl -X GET -H "Authorization: Bearer ${{ secrets.REGRU_API_KEY }}" \
           -H "Content-Type: application/json" \
           'https://api.cloudvps.reg.ru/v1/reglets/${{ vars.REGRU_SERVER_ID }}' -s | \
           awk '/"status":/ {match($2, /[a-z]+/); print substr($2, RSTART, RLENGTH)}')

          if [[ "$STATUS" != "off" ]]; then
            # Here "still running" is not the only problem possible.
            # For example, `suspended` means "no money".
            # See https://developers.cloudvps.reg.ru/reglets/info.html
            # Server can take a long time to shut down, so don't fail here.
            echo "::warning title=Shutdown failed::Server was not shut down properly. Status is $STATUS."
          fi
